name: Build and Deploy to Production Branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portifolio/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./portifolio
        run: npm ci

      - name: ðŸ”¨ Build project
        working-directory: ./portifolio
        run: npm run build

      - name: ðŸ“‚ Verify build
        working-directory: ./portifolio
        run: |
          echo "Build directory contents:"
          ls -la dist/
          echo "Build completed successfully!"

      - name: ðŸ“„ Create .htaccess
        working-directory: ./portifolio/dist
        run: |
          cat > .htaccess << 'EOF'
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-l
            RewriteRule . /index.html [L]
          </IfModule>
          EOF

      - name: ðŸš€ Deploy to production branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Checkout production branch
          git checkout production || git checkout --orphan production
          
          # Remove all files except .git
          git rm -rf . 2>/dev/null || true
          
          # Copy build files
          cp -r portifolio/dist/* .
          
          # Create deploy info
          echo "Deploy realizado em: $(date)" > DEPLOY_INFO.txt
          echo "Commit: ${{ github.sha }}" >> DEPLOY_INFO.txt
          echo "Branch de origem: main" >> DEPLOY_INFO.txt
          
          # Commit and push
          git add -A
          git commit -m "Deploy: $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push -f origin production

      - name: âœ… Deployment completed
        run: echo "ðŸŽ‰ Production branch updated! Webhook will trigger Hostinger deploy."

