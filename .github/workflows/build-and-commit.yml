name: Build and Commit to Deploy Branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portifolio/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./portifolio
        run: npm ci

      - name: ðŸ”¨ Build project
        working-directory: ./portifolio
        run: npm run build

      - name: ðŸ“‚ Deploy to production branch
        run: |
          # Configurar git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Criar/limpar branch de produÃ§Ã£o
          git checkout -B production
          
          # Remover tudo exceto o build
          git rm -rf .
          git clean -fxd
          
          # Copiar arquivos do build
          cp -r portifolio/dist/* .
          cp portifolio/dist/.htaccess . 2>/dev/null || :
          
          # Adicionar arquivos
          git add -A
          
          # Commit
          git commit -m "Deploy: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # Push forÃ§ado para branch production
          git push -f origin production

      - name: âœ… Deployment completed
        run: echo "ðŸŽ‰ Build deployed to production branch!"

